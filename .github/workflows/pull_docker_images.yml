# This workflow will pull kolla ansible docker images from dockerhub, push it to aliyun container registry.
#
# To configure this workflow:
#
# 1. Set up secrets in your workspace: 
#    - ALIYUN_USERNAME with aliyun registry username
#    - ALIYUN_PASSWORD with aliyun registry password
#
# 2. Change the values for the ALIYUN_REGISTRY, ALIYUN_NAMESPACE  environment variables (below).

name: CI
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  DOCKERHUB_USERNAME: willdockerhub
  ALI_USERNAME: willzhmic@outlook.com
  ALI_REGISTRY_URL: registry.cn-shenzhen.aliyuncs.com
  ALI_REGISTRY_NAMESPACE: images_mirror

jobs:
  get-kolla-images:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    # Log into aliyun registry
    - name: Log into aliyun registry
      run: |
        echo "${{ secrets.ALIYUN_PASSWORD }}" | docker login $ALIYUN_REGISTRY -u ${{ secrets.ALIYUN_USERNAME }} --password-stdin
        echo "${{ secrets.DOCKERHUB_USERNAME }}" | docker login -u ${{ secrets.DOCKERHUB_PASSWORD }} --password-stdin 

    # get images list
    - name: get images
      run: sh pull_by_yourself.sh

    - name: list images
      run: |
        docker images --format "{{.Repository}}:{{.Tag}}" | grep $ALI_REGISTRY_URL
        docker images --format "{{.Repository}}:{{.Tag}}" | grep $DOCKERHUB_USERNAME
